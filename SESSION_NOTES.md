# Quotation Tool - Session Notes & Next Steps

## Project Overview

A client needs a quotation tool for **GB products** (coir/coconut fiber) sourced from **India** and **Sri Lanka**. The tool takes product specifications and a shipping destination as input, then outputs pricing comparisons (FOB price, freight, total cost per unit, transit time) for both origins side by side.

**Note:** "GB" is the prefix used in product codes and sheet names (`IN-GB`, `SL-GB`). The full meaning has not been confirmed by the client — do NOT assume it stands for "Garden Border". Needs clarification.

## Source Files

The script auto-detects files by glob pattern in the same folder:

- **`Price List *.xlsx`** (e.g. `Price List Feb.xlsx`) — Product catalog with 15 sheets. Key sheets: `IN-GB` (71 India products), `SL-GB` (246 Sri Lanka products). Columns A-Y: product number, description, unit of measure, weight, pieces per pallet (7 weight tiers), pieces per container (7 tiers), FOB price per unit (7 tiers). Data starts at row 6. Updated monthly.
- **`Freight*.xlsx`** — Two sheets:
  - **`Freight`**: 1,952 rows of shipping charge line items. 2 origin ports (Tuticorin IN, Colombo LK) to 70 destinations. Each route has 10–15 charge code rows (BAS, CFD, ERS, etc.) in USD/EUR. 9 columns: Receipt, Delivery, Origin MOT, Dest MOT, Transit Time, Charge Code, Rate Basis, Currency, Rate (per 40HDRY container). 29 unique charge codes total.
  - **`Tonnage`**: 90 port entries with weight limits. Headers (row 2): Port Name, Country Name, Port Code, Net weight MT, Allowed Cargo Gross weight MT, Container type, Comments. Contains 40HC and 20GP entries (Japan has both). The script filters to 40HC only.
- **`079864e1-8214-46f3-91be-e89a83dc172e.png`** — Reference screenshot from client showing the desired layout/output format.

## What Was Built

### Quotation Tool (v3 — with tonnage integration)

- **`Quotation_Tool.xlsx`** — Excel workbook with formula-based lookups (no VBA). Generated by Python script.
- **`build_quotation_tool.py`** — Python script (uses openpyxl) that reads the Price List, Freight data, and Tonnage sheet, parses product descriptions via regex, aggregates freight data, auto-derives weight tiers per destination, and generates the tool.
- **`test_quotation_tool.py`** — Comprehensive test suite (9 tests) that validates the generated workbook (structure, named ranges, data integrity, formula logic, dropdown validations, Windows compatibility, tonnage integration).

### Tonnage Research (session 3, reference only)

- **`Tonnage_Complete.xlsx`** — Complete tonnage reference file covering all 70 freight destinations with researched legal maximums. **Not used by the tool** — kept for reference only. The tool uses only the client-provided Tonnage sheet from `Freight.xlsx`.
- **`Port_Tonnage_Report.xlsx`** — Initial 5-tab report (superseded by Tonnage_Complete.xlsx)

### Current Architecture

```
Quote sheet (visible):
  - 7 dropdown inputs: GB Size, Chips/Pith Ratio, EC Level, Plastic Duration,
    Holes, BSU, Port of Destination
  - 1 auto-derived display: Container Gross Weight (MT) — grey background,
    shows "24 MT" or "23 MT (UNCONFIRMED)" based on destination
  - 1 manual input: EUR/USD Exchange Rate (default 1.08)
  - Tonnage warning row (row 13): red banner when using unconfirmed default weight
  - Results table: India row + Sri Lanka row
    Columns: Source, Product Code, FOB Price/Unit, Freight/Container,
             Units/Container, Freight/Unit, Total Cost/Unit, Transit Time
  - Conditional formatting: amber tint on FOB, Units, Total when weight unconfirmed
  - Warning messages (red italic) for no-match scenarios
  - Full product description display for matched products
  - Hidden helper column (K) with MATCH formulas

Hidden data sheets:
  - IN_GB: 71 products, 6-field lookup key + parsed attributes + PCS + FOB
  - SL_GB: 246 products, same structure
  - Freight: 140 routes (cheapest per country+destination), aggregated USD+EUR totals,
    plus Gross_Weight_MT (col H) and Weight_Confirmed (col I) per route
  - Lists: unique dropdown values for all input fields + weight tiers

Named ranges (24 total):
  IN_Keys, IN_ProdNos, IN_Descs, IN_PCS, IN_FOB,
  SL_Keys, SL_ProdNos, SL_Descs, SL_PCS, SL_FOB,
  FR_Keys, FR_Transit, FR_USD, FR_EUR, FR_GrossWT, FR_Confirmed,
  SizeList, ChipsList, ECList, PlasticList, HolesList, BSUList, DestList, WeightTiers
```

### How It Works (End to End)

1. **Python script reads** the Price List, Freight sheet, and Tonnage sheet
2. **Parses product descriptions** via regex into 6 searchable attributes (size, chips/pith, EC level, plastic, holes, BSU)
3. **Aggregates freight charges** per route (summing all charge codes), picks cheapest Indian port per destination
4. **Matches tonnage** to freight destinations (37 confirmed from client data, 33 default to 23 MT)
5. **Generates Excel workbook** with hidden data sheets, named ranges, and formula-driven Quote sheet
6. **Client opens Excel**, selects 7 dropdowns → weight tier auto-derives from destination → formulas do MATCH/INDEX lookups → results appear instantly
7. **Warning system** alerts when tonnage is unconfirmed (red banner + amber result cells)
8. **Client compares** India vs Sri Lanka rows to decide which origin gives the better deal

### Product Description Parsing (Regex)

Descriptions like `GB 100x18x16 PLF 3070 NW P3Y + HOLES` are parsed into:

| Field | Regex | Examples |
|-------|-------|----------|
| Size | `(\d+)\s*[xX]\s*(\d+)\s*[xX]\s*(\d+)` | 100X18X16, 100X15X12 |
| Chips/Pith | `(PLF\s*\d+\|PRO\s*\d+\|\d+mm)` | PLF 3070, PRO 8020, 16MM |
| EC Level | `\b(NW\|WA\|EW\|TR\|FT)\b` | NW, WA, EW, TR |
| Plastic | `(P\d+Y)` | P1Y, P2Y, P3Y, P4Y |
| Holes | `NO\s*HOLES` or `HOLES` | HOLES, NO HOLES, N/A |
| BSU | `\bBSU\b` | BSU, N/A |

Lookup key = `size|chips|ec|plastic|holes|bsu` (6 pipe-separated fields).

### Freight Charge Structure

Each shipping route has 10–15 individual charge code rows that **must be summed** to get the total shipping cost per container. This is how freight invoices work — each line item is a separate surcharge component:

| Code | Meaning |
|------|---------|
| BAS | Base ocean freight |
| ERS | Emergency Risk Surcharge |
| VP1 | Vessel Performance Surcharge |
| OBK | Origin Bill of Lading |
| DHC | Destination Handling Charge |
| CFD/CFO | Container Freight Station |
| CP1/CP3 | Container Positioning |
| EBS/ECS | Emergency Bunker/Container Surcharge |
| IFS | Intermodal Fuel Surcharge |
| OHC/OCI | Origin Handling Charge |
| PAI | Port Additional Inspection |
| PSS | Peak Season Surcharge |
| Others | EHI, EMS, EXP, FDH, FRO, IHI, IMP, LWC, PCC, PSI, RHI, CVO, DTI |

The freight aggregation logic in the Python script:
- All charge line items for a route are summed (USD separate from EUR)
- For India, the cheapest port is selected per destination (currently only Tuticorin in the data)
- Transit time extracted as integer from strings like "46 Days"
- Freight lookup key = `country|destination` (e.g. "India|Adelaide, AU")

**Suspiciously cheap routes** (may have missing base rates): Busan ($76), Kaohsiung ($81), Laem Chabang ($85)

### EUR/USD Exchange Rate — Why It's Needed

148 out of 1,952 freight charge lines are in EUR (not USD), affecting 44 routes. These are **European destinations** (Spain, Italy, Portugal, Greece, Bulgaria, Ireland). The EUR charges are local fees like DHC (Destination Handling Charge, EUR 189–275), CP1 (EUR 18–23), EHI/IHI, and PAI. The tool converts these to USD using the editable exchange rate (default 1.08) to compute a single freight total per route.

### Client's 1.0605 Multiplier

The client uses a multiplier of **1.0605** (= 1.01 × 1.05) applied on top of freight costs. This likely represents:
- **1.01** = 1% insurance surcharge
- **1.05** = 5% margin/buffer

**Issue identified:** The client was applying this to BAS (base rate) only, not the total freight. This underestimates actual freight by ~38% on average, because surcharges (ERS, VP1, DHC, etc.) add significant cost on top of the base rate. The correct approach is to sum all charge codes first, then apply the multiplier to the total.

### Weight Tiers and Tonnage (Session 4 — Integrated)

**Weight tiers in Price List:** 19.5, 22, 23, 24, 25, 26, 27 MT — these are the only 7 tiers. Each tier has its own columns for pieces/container and FOB price/unit.

**Tonnage integration approach:**
- Uses **only client-provided data** from the Tonnage sheet in `Freight.xlsx`
- Filters to **40HC entries only** (ignores 20GP Japan entries)
- For Japan ports with 2-axle/3-axle options, keeps the **highest gross weight** (3-axle)
- Matches tonnage port names to freight destinations via city name + 5 hardcoded overrides
- **Default: 23 MT** for any destination without client data
- Weight tier is auto-derived using Excel `MATCH(gross_weight, WeightTiers, 1)` (approximate match — finds largest tier ≤ gross weight)

**Tonnage matching results (37 confirmed, 33 default):**

| Weight | Confirmed | Default | Destinations |
|--------|-----------|---------|--------------|
| 20 MT | 1 | — | Hakata (JP) |
| 22 MT | 3 | — | Busan, Kaohsiung, Tema |
| 23 MT | 4 | 33 | Altamira, Manzanillo, Toronto, Veracruz + 33 unmatched |
| 24 MT | 8 | — | Spanish ports (7) + Burgas |
| 25 MT | 13 | — | Ashdod, Brisbane, Callao, Leixoes, Melbourne, etc. |
| 26 MT | 5 | — | London Gateway, Osaka, Southampton, Yokohama, Durban |
| 27 MT | 3 | — | Agadir, Casablanca, Poti |

**Tonnage name-matching overrides** (hardcoded in `read_tonnage()`):
- `London Gateway, GB` → `LONDON GATEWAY TERMINAL`
- `Las Palmas de Gran Canaria, ES` → `Las Palmas`
- `Lisbon, PT` → `Lisbao`
- `Yokohama, JP` → `Yokohoma`
- `Guayaquil-Posorja, EC` → `Guayaquil`

**Cartagena, CO** is explicitly NOT matched (tonnage says Spain, freight says Colombia).

### Warning System for Unconfirmed Tonnage

Three layers of visual alerts when a destination uses the default 23 MT:

1. **B11 cell** — displays "23 MT (UNCONFIRMED)" + conditional formatting turns red
2. **Row 13 warning banner** — red background, white text: *"WARNING: No confirmed weight data for this destination. Using default 23 MT. Verify before quoting."*
3. **Result cells** — pale amber conditional formatting on FOB Price, Units/Container, and Total Cost columns

### Helper Cell Reference (Column K, hidden)

| Cell | Formula | Purpose |
|------|---------|---------|
| K4 | `=B4&"\|"&B5&"\|"&B6&"\|"&B7&"\|"&B8&"\|"&B9` | Product lookup key |
| K5 | `=IFERROR(MATCH(K11,WeightTiers,1),0)` | Weight tier index (approximate match) |
| K6 | `=AND(B4<>"",B5<>"",B6<>"",B7<>"",B8<>"",B9<>"",B10<>"")` | All 7 inputs filled? |
| K7 | `=IFERROR(MATCH(K4,IN_Keys,0),0)` | India product match row |
| K8 | `=IFERROR(MATCH(K4,SL_Keys,0),0)` | Sri Lanka product match row |
| K9 | `=IFERROR(MATCH("India\|"&B10,FR_Keys,0),0)` | India freight match row |
| K10 | `=IFERROR(MATCH("Sri Lanka\|"&B10,FR_Keys,0),0)` | Sri Lanka freight match row |
| K11 | `=IF(K9>0,INDEX(FR_GrossWT,K9),IF(K10>0,INDEX(FR_GrossWT,K10),0))` | Gross weight from tonnage |
| K12 | `=IF(K9>0,INDEX(FR_Confirmed,K9),IF(K10>0,INDEX(FR_Confirmed,K10),0))` | Confirmed flag (1/0) |

## Known Issues

### Remaining Duplicate Keys

After adding Holes/BSU/PRO parsing, duplicate keys dropped significantly but some remain:

- **IN-GB**: 6 duplicate keys (down from 14)
- **SL-GB**: 46 duplicate keys

**Root cause:** The 6 input parameters are **not sufficient to uniquely identify every product**. Remaining duplicates are caused by:

1. **Color variants** — black vs white plastic bag (values ARE in the descriptions)
2. **(SP) designation** — special variants
3. **Gauge/thickness** — e.g. "550 Guage"
4. **Volume/label variants** — e.g. "25.2L-EN", "28.8L-EN"
5. **Fiber modifications** — "20% extra fiber", "double sieved", "Fines removed"
6. **True duplicates** — different product codes, completely identical data across every column

Currently: first match is returned. User can verify via "Full Description" display.

### Cartagena Country Mismatch

Client's Tonnage sheet lists "Cartagena" under **Spain**, but the freight destination is **Cartagena, CO** (Colombia). These are two different cities — Spanish weight limits do not apply to Colombia. The tool does NOT match these — Cartagena, CO gets the default 23 MT. Client should clarify.

### Tonnage Data Quality Issues

The build script detects and reports these issues during execution:

- **Swapped fields**: Row 92 — Port="Germany", Country="Hamburg" (reversed)
- **Misspellings**: "Yokohoma" (Yokohama), "Lisbao" (Lisboa/Lisbon), "Le harve" (Le Havre)
- **Trailing whitespace**: Tenerife, New York, Savannah, Guayaquil, MATSUYAMA
- **Inconsistent casing**: LONDON GATEWAY TERMINAL, MATSUYAMA, HAKATA, BORDEAUX, MOIN in ALL CAPS
- **Duplicate entries**: BORDEAUX appears twice (identical data)
- **Annotations in names**: "Varna (DAP, Bulgaria)**", "Boston MA (Massachusetts)"
- **Cartagena mismatch**: tonnage=Spain, freight=Colombia

These are cosmetic/data-quality issues in the source file — the script handles them via name cleaning and the override table.

### Ashdod/Israel Discrepancy

OOCL lists Israel road transport at 33T gross, but the client's Tonnage sheet has 25T gross for Ashdod. The tool uses the client's value (25T). Needs clarification.

### Suspiciously Cheap Routes

Busan ($76), Kaohsiung ($81), Laem Chabang ($85) — may have missing base rates. Client should verify.

## Decisions Made

1. **Excel with formulas** (not VBA, not web app) — easy to share, familiar to business users, ability to hide/protect sheets with sensitive pricing data
2. **Python script for monthly data refresh** — considered pure Excel (paste-in data sheets with Excel Tables), but parsing descriptions without regex is too complex; script approach is simpler
3. **Package as .exe for client** — client won't have Python installed; PyInstaller bundles everything into a single executable
4. **Only GB product sheets** (IN-GB and SL-GB) are in scope for now
5. **Exact matching only** — no fuzzy/closest-equivalent matching. Show clear "No results found" messages instead
6. **Cheapest Indian port** auto-selected per destination
7. **Relative paths with auto-detection** — script finds `Price List*.xlsx` and `Freight*.xlsx` in its own folder, works on any machine
8. **Sum all freight charge codes** per route (not just BAS × multiplier) for accurate freight totals
9. **Client's Tonnage data only** — the Tonnage_Complete.xlsx research is kept for reference but the tool uses solely the client-provided Tonnage sheet from Freight.xlsx
10. **Default 23 MT** for unmatched destinations, with prominent visual warnings to alert the user
11. **Auto-derive weight tier** from destination (removed manual dropdown) — reduces user error and ensures consistency with client's tonnage data

## Validation Results (Session 4)

Ran comprehensive test suite — **all 9 tests passed**:

| Test | Result |
|------|--------|
| Workbook structure (5 sheets, Quote first) | PASS |
| All 24 named ranges present | PASS |
| Data integrity (71 IN + 246 SL products, 140 routes, tonnage cols) | PASS |
| Formula arithmetic simulation (auto-derived weight) | PASS |
| Quote sheet formulas (K4-K12, B11 auto-derive, A13 warning) | PASS |
| 7 dropdown data validations (weight dropdown removed) | PASS |
| Windows Excel compatibility (standard functions only) | PASS |
| No division-by-zero risks, no negative freight | PASS |
| Tonnage integration (consistent weights, valid tiers, conditional formatting) | PASS |

Functions used: IF, AND, OR, NOT, INDEX, MATCH, IFERROR — all standard, all Windows-compatible.

## TODO

### High Priority — Awaiting Client Response
- [ ] **Clarify what "GB" stands for** — currently unknown
- [ ] **Duplicate handling** — client must decide if more input filters are needed or if first-match is acceptable; also confirm whether true duplicates are intentional
- [ ] **Cartagena country** — confirm whether Cartagena in the freight file is Colombia or Spain (freight data says CO)
- [ ] **Ashdod/Israel** — confirm 25T (client) vs 33T (OOCL) weight limit
- [ ] **Freight summing approach** — confirm with client: are they summing all charge codes or just picking BAS × 1.0605?
- [ ] **Suspiciously cheap routes** — verify Busan ($76), Kaohsiung ($81), Laem Chabang ($85) for missing base rates
- [ ] **Tonnage data cleanup** — ask client to fix misspellings, swapped fields, and Cartagena country in the Tonnage sheet
- [ ] **33 unconfirmed destinations** — client should provide tonnage for the destinations currently defaulting to 23 MT (see list in build script output)

### High Priority — Technical
- [x] ~~**Integrate tonnage into the tool**~~ — done in session 4
- [ ] **Package as Windows .exe** — run `pyinstaller --onefile build_quotation_tool.py` on a Windows machine, test the exe
- [ ] **Test in Windows Excel** — open the .xlsx on Windows, try various input combinations, verify dropdowns, auto-derived weight, and warning system work
- [ ] **Sheet protection** — password-protect hidden sheets so the client can share the file without exposing raw pricing data

### Medium Priority
- [ ] **Folder structure** — set up a clean delivery folder: exe + source files + output
- [ ] **Edge cases** — products with missing sizes, empty chips/pith fields, or unparseable descriptions
- [ ] **EUR/USD rate** — confirm with client if 1.08 default is appropriate

### Low Priority / Future Enhancements
- [ ] **Extend to other product types** (OT, GS, OS sheets) if the client requests
- [ ] **Add 5KG product support** (different sheet structure)
- [ ] **Multiple results display** — if user wants to see all matching products (not just first)
- [ ] **Conditional formatting** — color-code the cheaper option (India vs Sri Lanka) in the results

## Key Files

```
Repository: https://github.com/ajnobre/tomer_excel-route-cost
  build_quotation_tool.py      <- Python generator script (v3, with tonnage integration)
  test_quotation_tool.py       <- test suite (9 tests)
  Quotation_Tool.xlsx          <- generated tool (latest)
  Price List Feb.xlsx          <- source: product catalog (current month)
  Freight.xlsx                 <- source: shipping rates + tonnage data (2 sheets)
  Tonnage_Complete.xlsx        <- tonnage research reference (NOT used by tool)
  Port_Tonnage_Report.xlsx     <- initial tonnage report (superseded)
  079864e1-...png              <- client's reference image
  SESSION_NOTES.md             <- this file
```

## Technical Notes

- Python 3 with openpyxl required (bundled in .exe via PyInstaller)
- Script uses `sys.frozen` detection to work as both .py and .exe
- Auto-detects source files via glob: `Price List*.xlsx`, `Freight*.xlsx`
- If multiple matches found, prompts user to choose
- Weight tiers: 19.5, 22, 23, 24, 25, 26, 27 MT (mapped to columns in price list)
- Weight tier auto-derived per destination using `MATCH(gross_weight, WeightTiers, 1)` (approximate, ascending)
- Only dealing with 40HDRY containers (all freight rates are PER_CONTAINER)
- Tonnage sheet filtered to 40HC only; Japan 3-axle (higher weight) preferred over 2-axle
- All Excel formulas use comma separators (en-US locale) — standard for .xlsx format
- Hidden sheets can be found in Excel: right-click any sheet tab → Unhide
- Conditional formatting uses FormulaRule with `$K$12=0` to detect unconfirmed tonnage

## Verified Tonnage Sources (Reference Only)

These sources were used to build `Tonnage_Complete.xlsx` but are **not used by the tool**. The tool relies solely on the client's Tonnage sheet.

| Source | URL | Authority |
|--------|-----|-----------|
| GOV.UK — HGV Maximum Weights | https://www.gov.uk/government/publications/hgv-maximum-weights/hgv-maximum-weights | Official (UK Government) |
| Unifeeder — Road Weight Limitations | https://www.unifeeder.com/shortsea/customer-info/road-weight-limitations | Semi-official (shipping company) |
| P&O Ferrymasters — Road Weight Limitations | https://www.poferrymasters.com/road-weight-limitations | Semi-official (shipping company) |
| RSA Ireland — Vehicle Weights & Dimensions | https://www.rsa.ie/road-safety/road-users/professional-drivers/vehicle-safety-legislation/weights-and-dimensions | Official (Irish Road Safety Authority) |
| OOCL — Japan Weight Limitations | https://www.oocl.com/usa/eng/localinformation/localnews/2008/Pages/customeradvisoryjapanrevisedweightlimitationseffectiveapril12008.aspx | Official (shipping line) |
| CMA CGM — Canada Max Cargo Weight | https://www.cma-cgm.com/assets/public/pdf/Advisory%20-%20Canada%20Intermodal%20Max%20Cargo%20Weight%20Guideline%205.pdf | Official (shipping line) |
| Maersk — Thailand Overweight Limitation | https://www.maersk.com/~/media_sc9/maersk/local-information/files/asia-pacific/thailand/import/advisory-roads-overweight-limitation-v1.pdf | Official (shipping line) |
| ONE Line — Tanzania Weight Restrictions | https://www.one-line.com/en/news/weight-restrictions-tanzania-effective-1st-march-2019 | Official (shipping line) |
| Cargo Network International — AU Limits | https://www.cargonetwork.com.au/container-weight-limitations/ | Semi-official (freight forwarder) |
| NHVR — AU Mass & Dimension | https://nhvr.gov.au/road-access/mass-dimension-and-loading/general-mass-and-dimension-limits | Official (AU Government) |
| OOCL — Israel Operational Restrictions | https://www.oocl.com/israel/eng/localinformation/operationalrestrictions | Official (shipping line) |
| Sumeil — SA Legal Weight Limits | https://sumeil.co.za/understanding-legal-weight-limits/ | Semi-official |
