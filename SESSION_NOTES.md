# Quotation Tool - Session Notes & Next Steps

## Project Overview

A client needs a quotation tool for **GB products** (coir/coconut fiber) sourced from **India** and **Sri Lanka**. The tool takes product specifications and a shipping destination as input, then outputs pricing comparisons (FOB price, freight, total cost per unit, transit time) for both origins side by side.

**Note:** "GB" is the prefix used in product codes and sheet names (`IN-GB`, `SL-GB`). The full meaning has not been confirmed by the client — do NOT assume it stands for "Garden Border". Needs clarification.

## Source Files

The script auto-detects files by glob pattern in the same folder:

- **`Price List *.xlsx`** (e.g. `Price List Feb.xlsx`) — Product catalog with 15 sheets. Key sheets: `IN-GB` (71 India products), `SL-GB` (246 Sri Lanka products). Columns A-Y: product number, description, unit of measure, weight, pieces per pallet (7 weight tiers), pieces per container (7 tiers), FOB price per unit (7 tiers). Data starts at row 6. Updated monthly.
- **`Freight*.xlsx`** — Two sheets:
  - **`Freight`**: 1,952 rows of shipping charge line items. 2 origin ports (Tuticorin IN, Colombo LK) to 70 destinations. Each route has 10–15 charge code rows (BAS, CFD, ERS, etc.) in USD/EUR. 9 columns: Receipt, Delivery, Origin MOT, Dest MOT, Transit Time, Charge Code, Rate Basis, Currency, Rate (per 40HDRY container). 29 unique charge codes total.
  - **`Tonnage`** (added in session 3): 90 ports with weight limits. Headers (row 2): Port Name, Country Name, Port Code, Net weight MT, Allowed Cargo Gross weight MT, Container type, Comments. The client's "Allowed Cargo Gross Weight" column follows a consistent convention: **Gross = Net + 1 MT** (not actual container tare weight of ~4T). This value maps directly to Price List weight tiers.
- **`079864e1-8214-46f3-91be-e89a83dc172e.png`** — Reference screenshot from client showing the desired layout/output format.

## What Was Built

### Quotation Tool (v2)

- **`Quotation_Tool.xlsx`** — Excel workbook with formula-based lookups (no VBA). Generated by Python script.
- **`build_quotation_tool.py`** — Python script (uses openpyxl) that reads both source files, parses product descriptions via regex, aggregates freight data, and generates the tool.
- **`test_quotation_tool.py`** — Comprehensive test suite that validates the generated workbook (structure, named ranges, data integrity, formula logic, dropdown validations, Windows compatibility).

### Tonnage Analysis (session 3)

- **`Tonnage_Complete.xlsx`** — Complete tonnage reference file covering all 70 freight destinations. Three sheets:
  - **Tonnage - Complete**: 70 rows, color-coded by data source and status:
    - Green (26): Client-provided, no tier gap
    - Orange (10): Client-provided but higher tiers legally possible
    - Blue (29): Researched with verified sources
    - Red (5): No data — Apapa (NG), Balboa (PA), Djibouti (DJ), Kingston (JM), Tunis (TN)
  - **Tier Gaps**: 13 ports where the client uses a lower tier than the legal maximum allows
  - **Sources**: 12 verified source URLs with authority levels (Official / Semi-official)
- **`Port_Tonnage_Report.xlsx`** — Initial 5-tab report (superseded by Tonnage_Complete.xlsx)

### Current Architecture

```
Quote sheet (visible):
  - 8 dropdown inputs: GB Size, Chips/Pith Ratio, EC Level, Plastic Duration,
    Holes, BSU, Port of Destination, Container Gross Weight (MT)
  - 1 manual input: EUR/USD Exchange Rate (default 1.08)
  - Results table: India row + Sri Lanka row
    Columns: Source, Product Code, FOB Price/Unit, Freight/Container,
             Units/Container, Freight/Unit, Total Cost/Unit, Transit Time
  - Warning messages (red italic) for no-match scenarios
  - Full product description display for matched products
  - Hidden helper column (K) with MATCH formulas

Hidden data sheets:
  - IN_GB: 71 products, 6-field lookup key + parsed attributes + PCS + FOB
  - SL_GB: 246 products, same structure
  - Freight: 140 routes (cheapest per country+destination), aggregated USD+EUR totals
  - Lists: unique dropdown values for all input fields

Named ranges used for all lookups (IN_Keys, SL_Keys, FR_Keys, etc.)
```

### How It Works (End to End)

1. **Python script reads** the Price List and Freight source files
2. **Parses product descriptions** via regex into 6 searchable attributes (size, chips/pith, EC level, plastic, holes, BSU)
3. **Aggregates freight charges** per route (summing all charge codes), picks cheapest Indian port per destination
4. **Generates Excel workbook** with hidden data sheets, named ranges, and formula-driven Quote sheet
5. **Client opens Excel**, selects 8 dropdowns → formulas do MATCH/INDEX lookups → results appear instantly
6. **Client compares** India vs Sri Lanka rows to decide which origin gives the better deal

### Product Description Parsing (Regex)

Descriptions like `GB 100x18x16 PLF 3070 NW P3Y + HOLES` are parsed into:

| Field | Regex | Examples |
|-------|-------|----------|
| Size | `(\d+)\s*[xX]\s*(\d+)\s*[xX]\s*(\d+)` | 100X18X16, 100X15X12 |
| Chips/Pith | `(PLF\s*\d+\|PRO\s*\d+\|\d+mm)` | PLF 3070, PRO 8020, 16MM |
| EC Level | `\b(NW\|WA\|EW\|TR\|FT)\b` | NW, WA, EW, TR |
| Plastic | `(P\d+Y)` | P1Y, P2Y, P3Y, P4Y |
| Holes | `NO\s*HOLES` or `HOLES` | HOLES, NO HOLES, N/A |
| BSU | `\bBSU\b` | BSU, N/A |

Lookup key = `size|chips|ec|plastic|holes|bsu` (6 pipe-separated fields).

### Freight Charge Structure

Each shipping route has 10–15 individual charge code rows that **must be summed** to get the total shipping cost per container. This is how freight invoices work — each line item is a separate surcharge component:

| Code | Meaning |
|------|---------|
| BAS | Base ocean freight |
| ERS | Emergency Risk Surcharge |
| VP1 | Vessel Performance Surcharge |
| OBK | Origin Bill of Lading |
| DHC | Destination Handling Charge |
| CFD/CFO | Container Freight Station |
| CP1/CP3 | Container Positioning |
| EBS/ECS | Emergency Bunker/Container Surcharge |
| IFS | Intermodal Fuel Surcharge |
| OHC/OCI | Origin Handling Charge |
| PAI | Port Additional Inspection |
| PSS | Peak Season Surcharge |
| Others | EHI, EMS, EXP, FDH, FRO, IHI, IMP, LWC, PCC, PSI, RHI, CVO, DTI |

The freight aggregation logic in the Python script:
- All charge line items for a route are summed (USD separate from EUR)
- For India, the cheapest port is selected per destination (currently only Tuticorin in the data)
- Transit time extracted as integer from strings like "46 Days"
- Freight lookup key = `country|destination` (e.g. "India|Adelaide, AU")

**Suspiciously cheap routes** (may have missing base rates): Busan ($76), Kaohsiung ($81), Laem Chabang ($85)

### EUR/USD Exchange Rate — Why It's Needed

148 out of 1,952 freight charge lines are in EUR (not USD), affecting 44 routes. These are **European destinations** (Spain, Italy, Portugal, Greece, Bulgaria, Ireland). The EUR charges are local fees like DHC (Destination Handling Charge, EUR 189–275), CP1 (EUR 18–23), EHI/IHI, and PAI. The tool converts these to USD using the editable exchange rate (default 1.08) to compute a single freight total per route.

### Client's 1.0605 Multiplier

The client uses a multiplier of **1.0605** (= 1.01 × 1.05) applied on top of freight costs. This likely represents:
- **1.01** = 1% insurance surcharge
- **1.05** = 5% margin/buffer

**Issue identified:** The client was applying this to BAS (base rate) only, not the total freight. This underestimates actual freight by ~38% on average, because surcharges (ERS, VP1, DHC, etc.) add significant cost on top of the base rate. The correct approach is to sum all charge codes first, then apply the multiplier to the total.

### Weight Tiers and Tonnage

**Weight tiers in Price List:** 19.5, 22, 23, 24, 25, 26, 27 MT — these are the only 7 tiers. Each tier has its own columns for pieces/container and FOB price/unit. The weight tier is not a free choice — it is determined by the destination port's weight limit.

**Client's Gross Weight convention:** The Tonnage sheet's "Allowed Cargo Gross Weight" column consistently equals Net + 1 MT. This is NOT the actual container gross weight (which would be Net + tare, where tare ≈ 4T). The client uses this column to select which Price List tier to use.

**Tier gap analysis:** 13 ports where the client's conservative tier is below the legal maximum:

| Country | Ports | Client Tier | Legal Max Tier | Gap |
|---------|-------|-------------|----------------|-----|
| Spain | Valencia, Barcelona, Las Palmas, Algeciras, Almeria, Tenerife, Bilbao | 24 | 25 | +1 |
| UK | London Gateway, Southampton | 26 | 27 | +1 |
| Italy | GioiaTauro | 25 | 27 | +2 |
| Portugal | Sines, Lisbao, Leixoes | 25 | 26 | +1 |

Higher tiers = more units per container = lower cost per unit. Client should confirm whether conservative values are intentional.

## Known Issues

### Remaining Duplicate Keys

After adding Holes/BSU/PRO parsing, duplicate keys dropped significantly but some remain:

- **IN-GB**: 6 duplicate keys (down from 14)
- **SL-GB**: 46 duplicate keys

**Root cause:** The 6 input parameters are **not sufficient to uniquely identify every product**. Remaining duplicates are caused by:

1. **Color variants** — black vs white plastic bag (values ARE in the descriptions)
2. **(SP) designation** — special variants
3. **Gauge/thickness** — e.g. "550 Guage"
4. **Volume/label variants** — e.g. "25.2L-EN", "28.8L-EN"
5. **Fiber modifications** — "20% extra fiber", "double sieved", "Fines removed"
6. **True duplicates** — different product codes, completely identical data across every column

Currently: first match is returned. User can verify via "Full Description" display.

### Cartagena Country Mismatch

Client's Tonnage sheet lists "Cartagena" under **Spain**, but the freight destination is **Cartagena, CO** (Colombia). These are two different cities — Spanish weight limits (Unifeeder 24.5T) do not apply to Colombia. Flagged in Tonnage_Complete.xlsx for client clarification.

### Ashdod/Israel Discrepancy

OOCL lists Israel road transport at 33T gross, but the client's Tonnage sheet has 25T gross for Ashdod. Needs clarification.

### Missing Tonnage Data (5 ports)

No reliable weight limit data found for: **Apapa (NG), Balboa (PA), Djibouti (DJ), Kingston (JM), Tunis (TN)**. AI-generated data for these ports was verified and found to be fabricated (ISO container max 30.48T passed off as country-specific road limits). Client must provide these values.

### Suspiciously Cheap Routes

Busan ($76), Kaohsiung ($81), Laem Chabang ($85) — may have missing base rates. Client should verify.

## Decisions Made

1. **Excel with formulas** (not VBA, not web app) — easy to share, familiar to business users, ability to hide/protect sheets with sensitive pricing data
2. **Python script for monthly data refresh** — considered pure Excel (paste-in data sheets with Excel Tables), but parsing descriptions without regex is too complex; script approach is simpler
3. **Package as .exe for client** — client won't have Python installed; PyInstaller bundles everything into a single executable
4. **Only GB product sheets** (IN-GB and SL-GB) are in scope for now
5. **Exact matching only** — no fuzzy/closest-equivalent matching. Show clear "No results found" messages instead
6. **Cheapest Indian port** auto-selected per destination
7. **Relative paths with auto-detection** — script finds `Price List*.xlsx` and `Freight*.xlsx` in its own folder, works on any machine
8. **Sum all freight charge codes** per route (not just BAS × multiplier) for accurate freight totals
9. **Client's Tonnage database as primary source** for weight tiers, with legal maximums documented separately for reference

## Validation Results (Session 2)

Ran comprehensive test suite — **all 8 tests passed**:

| Test | Result |
|------|--------|
| Workbook structure (5 sheets, Quote first) | PASS |
| All 22 named ranges present | PASS |
| Data integrity (71 IN + 246 SL products, 140 routes) | PASS |
| Formula arithmetic simulation | PASS |
| All 8 dropdown data validations | PASS |
| Windows Excel compatibility (standard functions only) | PASS |
| No division-by-zero risks | PASS |
| No negative freight values | PASS |

Functions used: IF, AND, OR, NOT, INDEX, MATCH, IFERROR — all standard, all Windows-compatible.

## TODO

### High Priority — Awaiting Client Response
- [ ] **Clarify what "GB" stands for** — currently unknown
- [ ] **Duplicate handling** — client must decide if more input filters are needed or if first-match is acceptable; also confirm whether true duplicates are intentional
- [ ] **5 missing tonnage ports** — client must provide weight limits for Apapa (NG), Balboa (PA), Djibouti (DJ), Kingston (JM), Tunis (TN)
- [ ] **Cartagena country** — confirm whether Cartagena in the freight file is Colombia or Spain (freight data says CO)
- [ ] **Tier gaps** — confirm whether the 13 conservative tier values are intentional, or if higher tiers should be used (especially GioiaTauro +2 tiers)
- [ ] **Ashdod/Israel** — confirm 25T (client) vs 33T (OOCL) weight limit
- [ ] **Freight summing approach** — confirm with client: are they summing all charge codes or just picking BAS × 1.0605?
- [ ] **Suspiciously cheap routes** — verify Busan ($76), Kaohsiung ($81), Laem Chabang ($85) for missing base rates

### High Priority — Technical
- [ ] **Integrate tonnage into the tool** — update `build_quotation_tool.py` to use the Tonnage sheet so weight tier is auto-selected per destination (instead of a manual dropdown)
- [ ] **Package as Windows .exe** — run `pyinstaller --onefile build_quotation_tool.py` on a Windows machine, test the exe
- [ ] **Test in Windows Excel** — open the .xlsx on Windows, try various input combinations, verify dropdowns and formulas work
- [ ] **Sheet protection** — password-protect hidden sheets so the client can share the file without exposing raw pricing data

### Medium Priority
- [ ] **Folder structure** — set up a clean delivery folder: exe + source files + output
- [ ] **Edge cases** — products with missing sizes, empty chips/pith fields, or unparseable descriptions
- [ ] **EUR/USD rate** — confirm with client if 1.08 default is appropriate

### Low Priority / Future Enhancements
- [ ] **Extend to other product types** (OT, GS, OS sheets) if the client requests
- [ ] **Add 5KG product support** (different sheet structure)
- [ ] **Multiple results display** — if user wants to see all matching products (not just first)
- [ ] **Conditional formatting** — color-code the cheaper option (India vs Sri Lanka) in the results

## Key Files

```
/Users/alvaronobre/Downloads/untitled folder/
  build_quotation_tool.py      ← Python generator script (v2, relative paths, Windows-ready)
  test_quotation_tool.py       ← test suite for validation
  Quotation_Tool.xlsx          ← generated tool (latest)
  Price List Feb.xlsx          ← source: product catalog (current month)
  Freight.xlsx                 ← source: shipping rates + tonnage data (2 sheets)
  Tonnage_Complete.xlsx        ← complete tonnage reference (70 destinations, color-coded)
  Port_Tonnage_Report.xlsx     ← initial tonnage report (superseded by Tonnage_Complete)
  079864e1-...png              ← client's reference image
  SESSION_NOTES.md             ← this file
```

## Technical Notes

- Python 3 with openpyxl required (bundled in .exe via PyInstaller)
- Script uses `sys.frozen` detection to work as both .py and .exe
- Auto-detects source files via glob: `Price List*.xlsx`, `Freight*.xlsx`
- If multiple matches found, prompts user to choose
- Weight tiers: 19.5, 22, 23, 24, 25, 26, 27 MT (mapped to columns in price list)
- Only dealing with 40HDRY containers (all freight rates are PER_CONTAINER)
- All Excel formulas use comma separators (en-US locale) — standard for .xlsx format
- Hidden sheets can be found in Excel: right-click any sheet tab → Unhide

## Verified Tonnage Sources

| Source | URL | Authority |
|--------|-----|-----------|
| GOV.UK — HGV Maximum Weights | https://www.gov.uk/government/publications/hgv-maximum-weights/hgv-maximum-weights | Official (UK Government) |
| Unifeeder — Road Weight Limitations | https://www.unifeeder.com/shortsea/customer-info/road-weight-limitations | Semi-official (shipping company) |
| P&O Ferrymasters — Road Weight Limitations | https://www.poferrymasters.com/road-weight-limitations | Semi-official (shipping company) |
| RSA Ireland — Vehicle Weights & Dimensions | https://www.rsa.ie/road-safety/road-users/professional-drivers/vehicle-safety-legislation/weights-and-dimensions | Official (Irish Road Safety Authority) |
| OOCL — Japan Weight Limitations | https://www.oocl.com/usa/eng/localinformation/localnews/2008/Pages/customeradvisoryjapanrevisedweightlimitationseffectiveapril12008.aspx | Official (shipping line) |
| CMA CGM — Canada Max Cargo Weight | https://www.cma-cgm.com/assets/public/pdf/Advisory%20-%20Canada%20Intermodal%20Max%20Cargo%20Weight%20Guideline%205.pdf | Official (shipping line) |
| Maersk — Thailand Overweight Limitation | https://www.maersk.com/~/media_sc9/maersk/local-information/files/asia-pacific/thailand/import/advisory-roads-overweight-limitation-v1.pdf | Official (shipping line) |
| ONE Line — Tanzania Weight Restrictions | https://www.one-line.com/en/news/weight-restrictions-tanzania-effective-1st-march-2019 | Official (shipping line) |
| Cargo Network International — AU Limits | https://www.cargonetwork.com.au/container-weight-limitations/ | Semi-official (freight forwarder) |
| NHVR — AU Mass & Dimension | https://nhvr.gov.au/road-access/mass-dimension-and-loading/general-mass-and-dimension-limits | Official (AU Government) |
| OOCL — Israel Operational Restrictions | https://www.oocl.com/israel/eng/localinformation/operationalrestrictions | Official (shipping line) |
| Sumeil — SA Legal Weight Limits | https://sumeil.co.za/understanding-legal-weight-limits/ | Semi-official |
