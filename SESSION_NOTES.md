# Quotation Tool - Session Notes & Next Steps

## Project Overview

A client needs a quotation tool for **GB products** (coir/coconut fiber) sourced from **India** (Cochin and Tuticorin ports) and **Sri Lanka** (Colombo port). The tool takes product specifications and a shipping destination as input, then outputs pricing comparisons (FOB price, freight, total cost per unit, transit time) for all 3 origin ports side by side.

**Note:** "GB" is the prefix used in product codes and sheet names (`IN-GB`, `SL-GB`). The full meaning has not been confirmed by the client — do NOT assume it stands for "Garden Border". Needs clarification.

## Source Files

The script auto-detects files by glob pattern in the same folder:

- **`Valid from*.xlsx`** (e.g. `Valid from 10.02.26 - Q1 2026.xlsx`) — Quarterly Maersk rate file. Key sheets:
  - **`RATE SHEET`**: Pre-calculated "ALL IN 40DRY/40HDRY" rates for 3 origins (Cochin IN, Tuticorin IN, Colombo LK) to 47 destinations. Columns: Origin, Destination, 20DRY sums, free time, ocean, ECS, ALL IN 20DRY, 40DRY/40HDRY equivalents (cols H-L). The ALL IN formula = sum of USD charges (excl ECS/PSS) + $60 free time extension + fixed ECS.
  - **`Transit Time`**: Charge-level rows with transit times per route (column K, e.g. "46 Days").
  - Also contains: General Disclaimer (quote terms), AFLS Quote (raw charges), Sheet3 (pivot), Abbreviation (charge code definitions).
- **`Price List *.xlsx`** (e.g. `Price List Feb.xlsx`) — Product catalog with 15 sheets. Key sheets: `IN-GB` (71 India products), `SL-GB` (246 Sri Lanka products). Columns A-Y: product number, description, unit of measure, weight, pieces per pallet (7 weight tiers), pieces per container (7 tiers), FOB price per unit (7 tiers). Data starts at row 6. Updated monthly.
- **`Freight*.xlsx`** — Now used **only for tonnage data**:
  - **`Tonnage`**: 90 port entries with weight limits. Headers (row 2): Port Name, Country Name, Port Code, Net weight MT, Allowed Cargo Gross weight MT, Container type, Comments. Contains 40HC and 20GP entries (Japan has both). The script filters to 40HC only.
  - (The `Freight` sheet in this file is no longer used — freight data now comes from the quarterly rate file.)
- **`079864e1-8214-46f3-91be-e89a83dc172e.png`** — Reference screenshot from client showing the desired layout/output format.

## What Was Built

### Quotation Tool (v4 — RATE SHEET + 3 origins)

- **`Quotation_Tool.xlsx`** — Excel workbook with formula-based lookups (no VBA). Generated by Python script.
- **`build_quotation_tool.py`** — Python script (uses openpyxl) that reads the quarterly Rate Sheet (ALL IN freight rates + transit times), Price List (product data), and Tonnage sheet (weight limits), parses product descriptions via regex, auto-derives weight tiers per destination, and generates the tool with 3 result rows (Cochin/Tuticorin/Colombo).
- **`test_quotation_tool.py`** — Comprehensive test suite (9 tests) that validates the generated workbook (structure, named ranges, data integrity, formula logic, dropdown validations, Windows compatibility, tonnage integration).

### Tonnage Research (session 3, reference only)

- **`Tonnage_Complete.xlsx`** — Complete tonnage reference file covering all 70 freight destinations with researched legal maximums. **Not used by the tool** — kept for reference only. The tool uses only the client-provided Tonnage sheet from `Freight.xlsx`.
- **`Port_Tonnage_Report.xlsx`** — Initial 5-tab report (superseded by Tonnage_Complete.xlsx)

### Current Architecture

```
Quote sheet (visible):
  - 7 dropdown inputs: GB Size, Chips/Pith Ratio, EC Level, Plastic Duration,
    Holes, BSU, Port of Destination
  - 1 auto-derived display: Container Gross Weight (MT) — grey background,
    shows "24 MT" or "23 MT (UNCONFIRMED)" based on destination
  - Tonnage warning row (row 13): red banner when using unconfirmed default weight
  - Results table: 3 rows (Cochin, IN / Tuticorin, IN / Colombo, LK)
    Columns: Source, Product Code, FOB Price/Unit, Freight/Container,
             Units/Container, Freight/Unit, Total Cost/Unit, Transit Time
  - Conditional formatting: amber tint on FOB, Units, Total when weight unconfirmed
  - Warning messages (row 21, red italic) for no-match scenarios
  - Full product description display (rows 23-24) for matched products
  - Hidden helper column (K) with MATCH formulas (K4-K13)

Hidden data sheets:
  - IN_GB: 71 products, 6-field lookup key + parsed attributes + PCS + FOB
  - SL_GB: 246 products, same structure
  - Freight: 141 routes (47 destinations × 3 origins), 8 columns:
    Key (origin|dest), Country, Origin, Destination, Transit_Days,
    All_In_USD (col F), Gross_Weight_MT (col G), Weight_Confirmed (col H)
  - Lists: unique dropdown values for all input fields + weight tiers

Named ranges (23 total):
  IN_Keys, IN_ProdNos, IN_Descs, IN_PCS, IN_FOB,
  SL_Keys, SL_ProdNos, SL_Descs, SL_PCS, SL_FOB,
  FR_Keys, FR_Transit, FR_AllIn, FR_GrossWT, FR_Confirmed,
  SizeList, ChipsList, ECList, PlasticList, HolesList, BSUList, DestList, WeightTiers
```

### How It Works (End to End)

1. **Python script reads** the quarterly Rate Sheet (ALL IN freight + transit times), Price List, and Tonnage sheet
2. **Parses product descriptions** via regex into 6 searchable attributes (size, chips/pith, EC level, plastic, holes, BSU)
3. **Reads ALL IN 40DRY/40HDRY rates** directly from the RATE SHEET — no charge aggregation needed. All 3 origins kept separately.
4. **Matches tonnage** to freight destinations (25 confirmed from client data, 22 default to 23 MT)
5. **Generates Excel workbook** with hidden data sheets, named ranges, and formula-driven Quote sheet
6. **Client opens Excel**, selects 7 dropdowns → weight tier auto-derives from destination → formulas do MATCH/INDEX lookups → results appear instantly
7. **Warning system** alerts when tonnage is unconfirmed (red banner + amber result cells)
8. **Client compares** all 3 origin rows (Cochin, Tuticorin, Colombo) to decide which gives the best deal

### Product Description Parsing (Regex)

Descriptions like `GB 100x18x16 PLF 3070 NW P3Y + HOLES` are parsed into:

| Field | Regex | Examples |
|-------|-------|----------|
| Size | `(\d+)\s*[xX]\s*(\d+)\s*[xX]\s*(\d+)` | 100X18X16, 100X15X12 |
| Chips/Pith | `(PLF\s*\d+\|PRO\s*\d+\|\d+mm)` | PLF 3070, PRO 8020, 16MM |
| EC Level | `\b(NW\|WA\|EW\|TR\|FT)\b` | NW, WA, EW, TR |
| Plastic | `(P\d+Y)` | P1Y, P2Y, P3Y, P4Y |
| Holes | `NO\s*HOLES` or `HOLES` | HOLES, NO HOLES, N/A |
| BSU | `\bBSU\b` | BSU, N/A |

Lookup key = `size|chips|ec|plastic|holes|bsu` (6 pipe-separated fields).

### Freight — RATE SHEET "ALL IN" Approach (Session 5)

The quarterly rate file contains a **RATE SHEET** tab with pre-calculated "ALL IN 40DRY/40HDRY" values per origin-destination pair. The ALL IN formula (computed by the client) is:

```
ALL IN = (BAS + USD surcharges excl ECS/PSS) + $60 Free Time Extension + Fixed ECS
```

The USD surcharges included: BAS, CFD, ERS, EXP, CFO, VP1, EBS, DTI, OBK, EMS, EHI.
Excluded: local currency charges (DHC, OHC, etc.), PSS, per-document charges.
ECS is a fixed standardized value ($1,000 for most routes, $850/$650 for Latin America).

The tool reads this ALL IN value directly — no charge-code aggregation needed.

- **3 origins**: Cochin, IN / Tuticorin, IN / Colombo, LK
- **47 destinations** (down from 70 — only destinations with RATE SHEET pricing)
- **Transit times** extracted from the Transit Time sheet in the same file
- **Freight lookup key** = `origin|destination` (e.g. `Cochin, IN|Agadir, MA`)
- **Cartagena, ES** is in the RATE SHEET but NOT in Transit Time → transit_days=0

**Note:** The old Freight.xlsx `Freight` sheet (with 1,952 charge-code rows) is no longer used. Only its `Tonnage` sheet is still read.

### Client's 1.0605 Multiplier (Implemented)

The client uses a multiplier of **1.0605** (= 1.01 × 1.05) applied on top of the **ALL IN** rate:
- **1.01** = 1% insurance surcharge
- **1.05** = 5% margin/buffer

Hardcoded in the Freight/Container formula:

```
Freight/Container = ALL_IN_USD × 1.0605
```

This flows through automatically to Freight/Unit and Total Cost/Unit.

### Weight Tiers and Tonnage (Session 4 — Integrated)

**Weight tiers in Price List:** 19.5, 22, 23, 24, 25, 26, 27 MT — these are the only 7 tiers. Each tier has its own columns for pieces/container and FOB price/unit.

**Tonnage integration approach:**
- Uses **only client-provided data** from the Tonnage sheet in `Freight.xlsx`
- Filters to **40HC entries only** (ignores 20GP Japan entries)
- For Japan ports with 2-axle/3-axle options, keeps the **highest gross weight** (3-axle)
- Matches tonnage port names to freight destinations via city name + 5 hardcoded overrides
- **Default: 23 MT** for any destination without client data
- Weight tier is auto-derived using Excel `MATCH(gross_weight, WeightTiers, 1)` (approximate match — finds largest tier ≤ gross weight)

**Tonnage matching results (25 confirmed, 22 default out of 47 destinations):**

| Weight | Confirmed | Default | Destinations |
|--------|-----------|---------|--------------|
| 23 MT | 3 | 22 | Altamira, Manzanillo, Veracruz + 22 unmatched |
| 24 MT | 9 | — | Spanish ports (8) + Burgas |
| 25 MT | 8 | — | Ashdod, Callao, Leixoes, etc. |
| 26 MT | 2 | — | London Gateway, Southampton |
| 27 MT | 3 | — | Agadir, Casablanca, Poti |

**Tonnage name-matching overrides** (hardcoded in `read_tonnage()`):
- `London Gateway, GB` → `LONDON GATEWAY TERMINAL`
- `Las Palmas de Gran Canaria, ES` → `Las Palmas`
- `Lisbon, PT` → `Lisbao`
- `Guayaquil-Posorja, EC` → `Guayaquil`
- `Cartagena, ES` → `Cartagena` (Spanish Cartagena now in destinations)

**Cartagena, CO** is explicitly NOT matched (tonnage says Spain, freight says Colombia).

### Warning System for Unconfirmed Tonnage

Three layers of visual alerts when a destination uses the default 23 MT:

1. **B11 cell** — displays "23 MT (UNCONFIRMED)" + conditional formatting turns red
2. **Row 13 warning banner** — red background, white text: *"WARNING: No confirmed weight data for this destination. Using default 23 MT. Verify before quoting."*
3. **Result cells** — pale amber conditional formatting on FOB Price, Units/Container, and Total Cost columns

### Helper Cell Reference (Column K, hidden)

| Cell | Formula | Purpose |
|------|---------|---------|
| K4 | `=B4&"\|"&B5&"\|"&B6&"\|"&B7&"\|"&B8&"\|"&B9` | Product lookup key |
| K5 | `=IFERROR(MATCH(K12,WeightTiers,1),0)` | Weight tier index (approximate match) |
| K6 | `=AND(B4<>"",B5<>"",B6<>"",B7<>"",B8<>"",B9<>"",B10<>"")` | All 7 inputs filled? |
| K7 | `=IFERROR(MATCH(K4,IN_Keys,0),0)` | India product match row |
| K8 | `=IFERROR(MATCH(K4,SL_Keys,0),0)` | Sri Lanka product match row |
| K9 | `=IFERROR(MATCH("Cochin, IN\|"&B10,FR_Keys,0),0)` | Cochin freight match row |
| K10 | `=IFERROR(MATCH("Tuticorin, IN\|"&B10,FR_Keys,0),0)` | Tuticorin freight match row |
| K11 | `=IFERROR(MATCH("Colombo, LK\|"&B10,FR_Keys,0),0)` | Colombo freight match row |
| K12 | `=IF(K9>0,INDEX(FR_GrossWT,K9),IF(K10>0,...,IF(K11>0,...,0)))` | Gross weight from tonnage (cascade) |
| K13 | `=IF(K9>0,INDEX(FR_Confirmed,K9),IF(K10>0,...,IF(K11>0,...,0)))` | Confirmed flag (1/0) |

## Known Issues

### Remaining Duplicate Keys

After adding Holes/BSU/PRO parsing, duplicate keys dropped significantly but some remain:

- **IN-GB**: 6 duplicate keys (down from 14)
- **SL-GB**: 46 duplicate keys

**Root cause:** The 6 input parameters are **not sufficient to uniquely identify every product**. Remaining duplicates are caused by:

1. **Color variants** — black vs white plastic bag (values ARE in the descriptions)
2. **(SP) designation** — special variants
3. **Gauge/thickness** — e.g. "550 Guage"
4. **Volume/label variants** — e.g. "25.2L-EN", "28.8L-EN"
5. **Fiber modifications** — "20% extra fiber", "double sieved", "Fines removed"
6. **True duplicates** — different product codes, completely identical data across every column

Currently: first match is returned. User can verify via "Full Description" display.

### Cartagena Country Mismatch

Client's Tonnage sheet lists "Cartagena" under **Spain**, but the freight destination is **Cartagena, CO** (Colombia). These are two different cities — Spanish weight limits do not apply to Colombia. The tool does NOT match these — Cartagena, CO gets the default 23 MT. Client should clarify.

### Tonnage Data Quality Issues

The build script detects and reports these issues during execution:

- **Swapped fields**: Row 92 — Port="Germany", Country="Hamburg" (reversed)
- **Misspellings**: "Yokohoma" (Yokohama), "Lisbao" (Lisboa/Lisbon), "Le harve" (Le Havre)
- **Trailing whitespace**: Tenerife, New York, Savannah, Guayaquil, MATSUYAMA
- **Inconsistent casing**: LONDON GATEWAY TERMINAL, MATSUYAMA, HAKATA, BORDEAUX, MOIN in ALL CAPS
- **Duplicate entries**: BORDEAUX appears twice (identical data)
- **Annotations in names**: "Varna (DAP, Bulgaria)**", "Boston MA (Massachusetts)"
- **Cartagena mismatch**: tonnage=Spain, freight=Colombia

These are cosmetic/data-quality issues in the source file — the script handles them via name cleaning and the override table.

### Ashdod/Israel Discrepancy

OOCL lists Israel road transport at 33T gross, but the client's Tonnage sheet has 25T gross for Ashdod. The tool uses the client's value (25T). Needs clarification.

### Cartagena, ES — Missing Transit Time

Cartagena, ES is in the RATE SHEET but NOT in the Transit Time sheet. The tool shows transit_days=0 for this destination. The client should update the Transit Time data.

### 23 Dropped Destinations

The following destinations were in the old Freight.xlsx but have no RATE SHEET pricing and are excluded from the tool: Adelaide, Apapa, Bangkok, Brisbane, Busan, Dar es Salaam, Djibouti, Durban, Fremantle, Hakata, Kaohsiung, Kobe, Laem Chabang, Melbourne, Mombasa, Montreal, Osaka, Sendai, Sydney, Taichung, Tema, Toronto, Vancouver, Yokohama. These are mainly Australia, Japan, East Asia, East Africa, and North America.

## Decisions Made

1. **Excel with formulas** (not VBA, not web app) — easy to share, familiar to business users, ability to hide/protect sheets with sensitive pricing data
2. **Python script for monthly data refresh** — considered pure Excel (paste-in data sheets with Excel Tables), but parsing descriptions without regex is too complex; script approach is simpler
3. **Package as .exe for client** — client won't have Python installed; PyInstaller bundles everything into a single executable
4. **Only GB product sheets** (IN-GB and SL-GB) are in scope for now
5. **Exact matching only** — no fuzzy/closest-equivalent matching. Show clear "No results found" messages instead
6. **All 3 origin ports shown** — Cochin, Tuticorin, Colombo each get their own result row for easy comparison
7. **Relative paths with auto-detection** — script finds `Valid from*.xlsx`, `Price List*.xlsx`, and `Freight*.xlsx` in its own folder
8. **ALL IN × 1.0605 multiplier** (hardcoded) — uses pre-calculated ALL IN rate from RATE SHEET, not individual charge codes
9. **Client's Tonnage data only** — the Tonnage_Complete.xlsx research is kept for reference but the tool uses solely the client-provided Tonnage sheet from Freight.xlsx
10. **Default 23 MT** for unmatched destinations, with prominent visual warnings to alert the user
11. **Auto-derive weight tier** from destination (removed manual dropdown) — reduces user error and ensures consistency with client's tonnage data
12. **47 destinations only** — restricted to destinations with RATE SHEET pricing (23 destinations without ALL IN rates were dropped)

## Validation Results (Session 5)

Ran comprehensive test suite — **all 9 tests passed**:

| Test | Result |
|------|--------|
| Workbook structure (5 sheets, Quote first) | PASS |
| All 23 named ranges present | PASS |
| Data integrity (71 IN + 246 SL products, 141 routes across 3 origins, tonnage cols) | PASS |
| Formula arithmetic simulation (3 origins, auto-derived weight) | PASS |
| Quote sheet formulas (K4-K13, 3 result rows, B11 auto-derive, A13 warning) | PASS |
| 7 dropdown data validations (weight dropdown removed) | PASS |
| Windows Excel compatibility (standard functions only) | PASS |
| All 3 origins serve same 47 destinations, no negative freight | PASS |
| Tonnage integration (consistent weights across origins, valid tiers, cond. formatting) | PASS |

Functions used: IF, AND, OR, NOT, INDEX, MATCH, IFERROR — all standard, all Windows-compatible.

## TODO

### High Priority — Awaiting Client Response
- [ ] **Clarify what "GB" stands for** — currently unknown
- [ ] **Duplicate handling** — client must decide if more input filters are needed or if first-match is acceptable; also confirm whether true duplicates are intentional
- [ ] **Cartagena country** — both Cartagena, CO and Cartagena, ES now in the tool. Confirm tonnage for each.
- [ ] **Ashdod/Israel** — confirm 25T (client) vs 33T (OOCL) weight limit
- [x] ~~**Freight approach**~~ — client confirmed: use ALL IN 40DRY/40HDRY × 1.0605 from RATE SHEET
- [ ] **Tonnage data cleanup** — ask client to fix misspellings, swapped fields in the Tonnage sheet
- [ ] **22 unconfirmed destinations** — client should provide tonnage for destinations currently defaulting to 23 MT (see list in build script output)
- [ ] **Cartagena, ES transit time** — missing from Transit Time sheet (shows 0 days in tool)

### High Priority — Technical
- [x] ~~**Integrate tonnage into the tool**~~ — done in session 4
- [x] ~~**Switch to RATE SHEET ALL IN**~~ — done in session 5
- [ ] **Package as Windows .exe** — run `pyinstaller --onefile build_quotation_tool.py` on a Windows machine, test the exe
- [ ] **Test in Windows Excel** — open the .xlsx on Windows, try various input combinations, verify dropdowns, auto-derived weight, 3 result rows, and warning system work
- [ ] **Sheet protection** — password-protect hidden sheets so the client can share the file without exposing raw pricing data

### Medium Priority
- [ ] **Folder structure** — set up a clean delivery folder: exe + source files + output
- [ ] **Edge cases** — products with missing sizes, empty chips/pith fields, or unparseable descriptions

### Low Priority / Future Enhancements
- [ ] **Extend to other product types** (OT, GS, OS sheets) if the client requests
- [ ] **Add 5KG product support** (different sheet structure)
- [ ] **Multiple results display** — if user wants to see all matching products (not just first)
- [ ] **Conditional formatting** — color-code the cheaper option (India vs Sri Lanka) in the results

## Key Files

```
Repository: https://github.com/ajnobre/tomer_excel-route-cost
  build_quotation_tool.py                  <- Python generator script (v4, RATE SHEET + 3 origins)
  test_quotation_tool.py                   <- test suite (9 tests)
  Quotation_Tool.xlsx                      <- generated tool (latest)
  Valid from 10.02.26 - Q1 2026.xlsx       <- source: quarterly rate file (RATE SHEET + Transit Time)
  Price List Feb.xlsx                      <- source: product catalog (current month)
  Freight.xlsx                             <- source: tonnage data only (Tonnage sheet)
  Tonnage_Complete.xlsx                    <- tonnage research reference (NOT used by tool)
  Port_Tonnage_Report.xlsx                 <- initial tonnage report (superseded)
  079864e1-...png                          <- client's reference image
  SESSION_NOTES.md                         <- this file
```

## Technical Notes

- Python 3 with openpyxl required (bundled in .exe via PyInstaller)
- Script uses `sys.frozen` detection to work as both .py and .exe
- Auto-detects source files via glob: `Valid from*.xlsx`, `Price List*.xlsx`, `Freight*.xlsx`
- If multiple matches found, prompts user to choose
- Weight tiers: 19.5, 22, 23, 24, 25, 26, 27 MT (mapped to columns in price list)
- Weight tier auto-derived per destination using `MATCH(gross_weight, WeightTiers, 1)` (approximate, ascending)
- Only dealing with 40HDRY containers (ALL IN rates from RATE SHEET)
- Tonnage sheet filtered to 40HC only; Japan 3-axle (higher weight) preferred over 2-axle
- All Excel formulas use comma separators (en-US locale) — standard for .xlsx format
- Hidden sheets can be found in Excel: right-click any sheet tab → Unhide
- Conditional formatting uses FormulaRule with `$K$13=0` to detect unconfirmed tonnage
- EUR/USD exchange rate input removed (ALL IN values are all USD)

## Verified Tonnage Sources (Reference Only)

These sources were used to build `Tonnage_Complete.xlsx` but are **not used by the tool**. The tool relies solely on the client's Tonnage sheet.

| Source | URL | Authority |
|--------|-----|-----------|
| GOV.UK — HGV Maximum Weights | https://www.gov.uk/government/publications/hgv-maximum-weights/hgv-maximum-weights | Official (UK Government) |
| Unifeeder — Road Weight Limitations | https://www.unifeeder.com/shortsea/customer-info/road-weight-limitations | Semi-official (shipping company) |
| P&O Ferrymasters — Road Weight Limitations | https://www.poferrymasters.com/road-weight-limitations | Semi-official (shipping company) |
| RSA Ireland — Vehicle Weights & Dimensions | https://www.rsa.ie/road-safety/road-users/professional-drivers/vehicle-safety-legislation/weights-and-dimensions | Official (Irish Road Safety Authority) |
| OOCL — Japan Weight Limitations | https://www.oocl.com/usa/eng/localinformation/localnews/2008/Pages/customeradvisoryjapanrevisedweightlimitationseffectiveapril12008.aspx | Official (shipping line) |
| CMA CGM — Canada Max Cargo Weight | https://www.cma-cgm.com/assets/public/pdf/Advisory%20-%20Canada%20Intermodal%20Max%20Cargo%20Weight%20Guideline%205.pdf | Official (shipping line) |
| Maersk — Thailand Overweight Limitation | https://www.maersk.com/~/media_sc9/maersk/local-information/files/asia-pacific/thailand/import/advisory-roads-overweight-limitation-v1.pdf | Official (shipping line) |
| ONE Line — Tanzania Weight Restrictions | https://www.one-line.com/en/news/weight-restrictions-tanzania-effective-1st-march-2019 | Official (shipping line) |
| Cargo Network International — AU Limits | https://www.cargonetwork.com.au/container-weight-limitations/ | Semi-official (freight forwarder) |
| NHVR — AU Mass & Dimension | https://nhvr.gov.au/road-access/mass-dimension-and-loading/general-mass-and-dimension-limits | Official (AU Government) |
| OOCL — Israel Operational Restrictions | https://www.oocl.com/israel/eng/localinformation/operationalrestrictions | Official (shipping line) |
| Sumeil — SA Legal Weight Limits | https://sumeil.co.za/understanding-legal-weight-limits/ | Semi-official |
